---
  - name: Build multi-vendor docs
    hosts: localhost
    connection: local
    gather_facts: no

    vars_files:
      - variables.yml

    tasks:

      - name: Create Index
        template: src=templates/index.tmpl dest=docs/index.rst

      - name: Create Introduction
        template: src=templates/intro.tmpl dest=docs/intro.rst

      - name: Create About
        template: src=templates/about.tmpl dest=docs/about.rst

      - name: Create FAQ
        template: src=templates/faq.tmpl dest=docs/faq.rst

      - name: Create Module Index
        template: src=templates/modules.tmpl dest=docs/modules.rst

      - name: Link Modules to Index
        lineinfile:
          dest: docs/modules.rst
          line: '   {{ item.name }}<{{ item.name }}/modules_list>'
        with_items: libraries

      - name: Get Ansible Repos
        git: repo={{ item.url }} dest=repos/{{ item.url | basename }} update=yes
        with_items: libraries

      - name: Remove previous doc folders
        file: path=docs/{{ item.name | replace(' ', '\ ') }} state=absent
        with_items: libraries

      - name: Make Ansible Docs
        docgen:
          module_dir: repos/{{ item.url | basename }}/{{ item.path }}
          output_dir: docs/{{ item.name }}
          make_index: false
          modules_title: "{{ item.name }}"
        with_items: libraries

      - name: Add Source Link
        lineinfile:
          dest: docs/{{ item.name }}/modules_list.rst
          insertbefore: '.. toctree::'
          line: 'These docs were dynamically created from the modules that can be found `here\n<{{ item.url }}>`_.\n'
        with_items: libraries

      - name: Make Clean
        command: /usr/bin/make clean chdir=docs/

      - name: Make HTML
        command: /usr/bin/make html chdir=docs/

